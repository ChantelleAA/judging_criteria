{% extends 'judging/base.html' %}
{% block title %}Judge {{ team.name }} - Quantathon{% endblock %}

{% block content %}
<!-- Back Navigation -->
<div class="row mb-4">
    <div class="col-12">
        <a href="{% url 'public_judge_access' %}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left me-2"></i>Back to Dashboard
        </a>
    </div>
</div>

<!-- Team Information -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-0" style="background: linear-gradient(135deg, #16a085 0%, #f4d03f 100%);">
            <div class="card-body text-white p-4">
                <div class="row align-items-center">
                    <div class="col-lg-8">
                        <h2 class="card-title mb-3">
                            <i class="bi bi-star-fill me-3"></i>
                            {{ team.name }}
                        </h2>
                        <div class="row">
                            <div class="col-md-6">
                                <h6><i class="bi bi-person-lines-fill me-2"></i>Team Members:</h6>
                                <p class="mb-3">{{ team.members }}</p>
                            </div>
                            <div class="col-md-6">
                                {% if team.presentation_link %}
                                    <a href="{{ team.presentation_link }}" 
                                       target="_blank" 
                                       class="btn btn-light btn-lg">
                                        <i class="bi bi-play-circle-fill me-2"></i>
                                        View Presentation
                                    </a>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-4 text-lg-end">
                        <div class="bg-white bg-opacity-20 rounded-3 p-3">
                            <h6 class="mb-2">Public Judge</h6>
                            <span class="badge bg-light text-dark me-1 mb-1">Community Voting</span>
                            <span class="badge bg-light text-dark me-1 mb-1">All Criteria</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Team Description -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-file-text me-2"></i>
                Project Description
            </div>
            <div class="card-body">
                <p class="card-text">{{ team.description|linebreaks }}</p>
            </div>
        </div>
    </div>
</div>

<!-- Judging Form -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-clipboard-check me-2"></i>
                Evaluation Form
            </div>
            <div class="card-body">
                <form method="post" id="judgingForm">
                    {% csrf_token %}
                    
                    <!-- Scoring Criteria -->
                    <div class="criteria-sections">
                        <!-- Quantum Tech Quality (40%) -->
                        <div class="criteria-section mb-4">
                            <div class="row align-items-center">
                                <div class="col-lg-6">
                                    <h5 class="text-primary mb-2">
                                        <i class="bi bi-cpu-fill me-2"></i>
                                        Quantum Tech Quality (Weight: 40%)
                                    </h5>
                                    <p class="text-muted mb-3">Technical implementation and quantum concepts</p>
                                </div>
                                <div class="col-lg-6">
                                    <div class="d-flex align-items-center justify-content-lg-end">
                                        <div class="form-group">
                                            <label for="quantum_tech_score">Score</label>
                                            <select class="form-control score-select"
                                                    name="quantum_tech_quality"
                                                    required
                                                    onchange="showOnlyNumber(this)">
                                                <option value="" selected hidden>— Select a Score —</option>
                                                <option value="1" data-label="1">
                                                    1 – Very Weak – Barely meets expectations or not at all.
                                                </option>
                                                <option value="2" data-label="2">
                                                    2 – Weak – Major gaps; needs significant improvement.
                                                </option>
                                                <option value="3" data-label="3">
                                                    3 – Fair – Adequate but unremarkable; meets minimum requirements.
                                                </option>
                                                <option value="4" data-label="4">
                                                    4 – Strong – Solid work with only minor issues.
                                                </option>
                                                <option value="5" data-label="5">
                                                    5 – Exceptional – Outstanding; exceeds expectations on all points.
                                                </option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-3">
                                <label class="form-label">Comments (Optional):</label>
                                <textarea class="form-control" name="comment_quantum_tech" rows="2" 
                                          placeholder="Share your thoughts on the quantum technology implementation..."></textarea>
                            </div>
                        </div>

                        <!-- Social Impact (25%) -->
                        <div class="criteria-section mb-4">
                            <div class="row align-items-center">
                                <div class="col-lg-6">
                                    <h5 class="text-primary mb-2">
                                        <i class="bi bi-globe me-2"></i>
                                        Social Impact (Weight: 25%)
                                    </h5>
                                    <p class="text-muted mb-3">Potential to benefit society and address real-world problems</p>
                                </div>
                                <div class="col-lg-6">
                                    <div class="d-flex align-items-center justify-content-lg-end">
                                        <div class="form-group">
                                            <label for="social_impact_score">Score</label>
                                            <select class="form-control score-select"
                                                    name="social_impact"
                                                    required
                                                    onchange="showOnlyNumber(this)">
                                                <option value="" selected hidden>— Select a Score —</option>
                                                <option value="1" data-label="1">
                                                    1 – Very Weak – Barely meets expectations or not at all.
                                                </option>
                                                <option value="2" data-label="2">
                                                    2 – Weak – Major gaps; needs significant improvement.
                                                </option>
                                                <option value="3" data-label="3">
                                                    3 – Fair – Adequate but unremarkable; meets minimum requirements.
                                                </option>
                                                <option value="4" data-label="4">
                                                    4 – Strong – Solid work with only minor issues.
                                                </option>
                                                <option value="5" data-label="5">
                                                    5 – Exceptional – Outstanding; exceeds expectations on all points.
                                                </option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-3">
                                <label class="form-label">Comments (Optional):</label>
                                <textarea class="form-control" name="comment_social_impact" rows="2" 
                                          placeholder="Share your thoughts on the social impact potential..."></textarea>
                            </div>
                        </div>

                        <!-- Innovation (20%) -->
                        <div class="criteria-section mb-4">
                            <div class="row align-items-center">
                                <div class="col-lg-6">
                                    <h5 class="text-primary mb-2">
                                        <i class="bi bi-lightbulb-fill me-2"></i>
                                        Innovation (Weight: 20%)
                                    </h5>
                                    <p class="text-muted mb-3">Creativity and novelty of approach</p>
                                </div>
                                <div class="col-lg-6">
                                    <div class="d-flex align-items-center justify-content-lg-end">
                                        <div class="form-group">
                                            <label for="innovation_score">Score</label>
                                            <select class="form-control score-select"
                                                    name="innovation"
                                                    required
                                                    onchange="showOnlyNumber(this)">
                                                <option value="" selected hidden>— Select a Score —</option>
                                                <option value="1" data-label="1">
                                                    1 – Very Weak – Barely meets expectations or not at all.
                                                </option>
                                                <option value="2" data-label="2">
                                                    2 – Weak – Major gaps; needs significant improvement.
                                                </option>
                                                <option value="3" data-label="3">
                                                    3 – Fair – Adequate but unremarkable; meets minimum requirements.
                                                </option>
                                                <option value="4" data-label="4">
                                                    4 – Strong – Solid work with only minor issues.
                                                </option>
                                                <option value="5" data-label="5">
                                                    5 – Exceptional – Outstanding; exceeds expectations on all points.
                                                </option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-3">
                                <label class="form-label">Comments (Optional):</label>
                                <textarea class="form-control" name="comment_innovation" rows="2" 
                                          placeholder="Share your thoughts on the innovation and creativity..."></textarea>
                            </div>
                        </div>

                        <!-- Presentation (10%) -->
                        <div class="criteria-section mb-4">
                            <div class="row align-items-center">
                                <div class="col-lg-6">
                                    <h5 class="text-primary mb-2">
                                        <i class="bi bi-presentation me-2"></i>
                                        Presentation (Weight: 10%)
                                    </h5>
                                    <p class="text-muted mb-3">How well the idea is communicated and presented</p>
                                </div>
                                <div class="col-lg-6">
                                    <div class="d-flex align-items-center justify-content-lg-end">
                                        <div class="form-group">
                                            <label for="presentation_score">Score</label>
                                            <select class="form-control score-select"
                                                    name="presentation"
                                                    required
                                                    onchange="showOnlyNumber(this)">
                                                <option value="" selected hidden>— Select a Score —</option>
                                                <option value="1" data-label="1">
                                                    1 – Very Weak – Barely meets expectations or not at all.
                                                </option>
                                                <option value="2" data-label="2">
                                                    2 – Weak – Major gaps; needs significant improvement.
                                                </option>
                                                <option value="3" data-label="3">
                                                    3 – Fair – Adequate but unremarkable; meets minimum requirements.
                                                </option>
                                                <option value="4" data-label="4">
                                                    4 – Strong – Solid work with only minor issues.
                                                </option>
                                                <option value="5" data-label="5">
                                                    5 – Exceptional – Outstanding; exceeds expectations on all points.
                                                </option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-3">
                                <label class="form-label">Comments (Optional):</label>
                                <textarea class="form-control" name="comment_presentation" rows="2" 
                                          placeholder="Share your thoughts on the presentation quality..."></textarea>
                            </div>
                        </div>

                        <!-- Business Viability (5%) -->
                        <div class="criteria-section mb-4">
                            <div class="row align-items-center">
                                <div class="col-lg-6">
                                    <h5 class="text-primary mb-2">
                                        <i class="bi bi-graph-up me-2"></i>
                                        Business Viability (Weight: 5%)
                                    </h5>
                                    <p class="text-muted mb-3">Potential for real-world implementation and commercial success</p>
                                </div>
                                <div class="col-lg-6">
                                    <div class="d-flex align-items-center justify-content-lg-end">
                                        <div class="form-group">
                                            <label for="business_viability_score">Score</label>
                                            <select class="form-control score-select"
                                                    name="business_viability"
                                                    required
                                                    onchange="showOnlyNumber(this)">
                                                <option value="" selected hidden>— Select a Score —</option>
                                                <option value="1" data-label="1">
                                                    1 – Very Weak – Barely meets expectations or not at all.
                                                </option>
                                                <option value="2" data-label="2">
                                                    2 – Weak – Major gaps; needs significant improvement.
                                                </option>
                                                <option value="3" data-label="3">
                                                    3 – Fair – Adequate but unremarkable; meets minimum requirements.
                                                </option>
                                                <option value="4" data-label="4">
                                                    4 – Strong – Solid work with only minor issues.
                                                </option>
                                                <option value="5" data-label="5">
                                                    5 – Exceptional – Outstanding; exceeds expectations on all points.
                                                </option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-3">
                                <label class="form-label">Comments (Optional):</label>
                                <textarea class="form-control" name="comment_business_viability" rows="2" 
                                          placeholder="Share your thoughts on the business viability..."></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- Overall Comments -->
                    <div class="criteria-section mb-4">
                        <h5 class="text-primary mb-3">
                            <i class="bi bi-chat-text me-2"></i>
                            Overall Comments
                        </h5>
                        <div class="mb-3">
                            <textarea class="form-control" name="comments" rows="4" 
                                      placeholder="Share your overall thoughts about this team's project..."></textarea>
                        </div>
                    </div>

                    <!-- Submission Controls -->
                    <div class="row">
                        <div class="col-12">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="text-muted">
                                    <i class="bi bi-info-circle me-2"></i>
                                    <small>You can only submit your judgment once. Please review carefully.</small>
                                </div>
                                <div>
                                    <button type="button" class="btn btn-outline-secondary me-2" onclick="resetForm()">
                                        <i class="bi bi-arrow-clockwise me-2"></i>Reset Form
                                    </button>
                                    <button type="submit" class="btn btn-success btn-lg" id="submitBtn">
                                        <i class="bi bi-check-circle me-2"></i>Submit Judgment
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Scoring Guide -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card border-info">
            <div class="card-header bg-info bg-opacity-10">
                <i class="bi bi-lightbulb me-2"></i>
                Scoring Guide
            </div>
            <div class="card-body">
                <div class="row g-3 text-center">
                    <div class="col-md">
                        <div class="p-3 bg-danger bg-opacity-10 rounded-3 h-100">
                            <h5 class="text-danger">1</h5>
                            <span class="badge bg-danger-subtle text-danger">Very Weak</span>
                            <p class="small mt-2 text-muted">Barely meets expectations or not at all.</p>
                        </div>
                    </div>
                    <div class="col-md">
                        <div class="p-3 bg-warning bg-opacity-10 rounded-3 h-100">
                            <h5 class="text-warning">2</h5>
                            <span class="badge bg-warning-subtle text-warning">Weak</span>
                            <p class="small mt-2 text-muted">Major gaps; needs significant improvement.</p>
                        </div>
                    </div>
                    <div class="col-md">
                        <div class="p-3 bg-info bg-opacity-10 rounded-3 h-100">
                            <h5 class="text-info">3</h5>
                            <span class="badge bg-info-subtle text-info">Fair</span>
                            <p class="small mt-2 text-muted">Adequate but unremarkable; meets minimum requirements.</p>
                        </div>
                    </div>
                    <div class="col-md">
                        <div class="p-3 bg-primary bg-opacity-10 rounded-3 h-100">
                            <h5 class="text-primary">4</h5>
                            <span class="badge bg-primary-subtle text-primary">Strong</span>
                            <p class="small mt-2 text-muted">Solid work with only minor issues.</p>
                        </div>
                    </div>
                    <div class="col-md">
                        <div class="p-3 bg-success bg-opacity-10 rounded-3 h-100">
                            <h5 class="text-success">5</h5>
                            <span class="badge bg-success-subtle text-success">Exceptional</span>
                            <p class="small mt-2 text-muted">Outstanding; exceeds expectations on all points.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Form validation
    document.getElementById('judgingForm').addEventListener('submit', function(e) {
        const scoreInputs = this.querySelectorAll('select[name*="quantum_tech_quality"], select[name*="social_impact"], select[name*="innovation"], select[name*="presentation"], select[name*="business_viability"]');
        let allValid = true;
        let emptyFields = [];

        scoreInputs.forEach(input => {
            if (!input.value || input.value === "") {
                allValid = false;
                input.classList.add('is-invalid');
                emptyFields.push(input.closest('.criteria-section').querySelector('h5').textContent.trim());
            } else {
                input.classList.remove('is-invalid');
            }
        });

        if (!allValid) {
            e.preventDefault();
            alert('Please fill in all score fields.\n\nMissing: ' + emptyFields.join(', '));
            return false;
        }

        // Confirmation dialog
        if (!confirm('Are you sure you want to submit your judgment? You cannot change it after submission.')) {
            e.preventDefault();
            return false;
        }
    });

    // Reset form function
    function resetForm() {
        if (confirm('Are you sure you want to reset all fields? This will clear all your scores and comments.')) {
            document.getElementById('judgingForm').reset();
            document.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
        }
    }

    function showOnlyNumber(select) {
        const selectedIndex = select.selectedIndex;
        const selectedOption = select.options[selectedIndex];
        if (selectedOption.value === "") return;

        // Set selected option text to just the number
        selectedOption.textContent = selectedOption.getAttribute("data-label");

        // Reset other options to full label
        for (let i = 0; i < select.options.length; i++) {
            if (i !== selectedIndex) {
                const option = select.options[i];
                const val = option.getAttribute("data-label");
                if (val === "1") option.textContent = "1 – Very Weak – Barely meets expectations or not at all.";
                if (val === "2") option.textContent = "2 – Weak – Major gaps; needs significant improvement.";
                if (val === "3") option.textContent = "3 – Fair – Adequate but unremarkable; meets minimum requirements.";
                if (val === "4") option.textContent = "4 – Strong – Solid work with only minor issues.";
                if (val === "5") option.textContent = "5 – Exceptional – Outstanding; exceeds expectations on all points.";
            }
        }
    }

    // Real-time score validation
    document.querySelectorAll('select.score-select').forEach(select => {
        select.addEventListener('change', function() {
            if (this.value) {
                this.classList.remove('is-invalid');
                this.classList.add('is-valid');
            } else {
                this.classList.remove('is-invalid', 'is-valid');
            }

            // Add visual feedback
            const value = parseInt(this.value);
            const wrapper = this.closest('.criteria-section');
            
            if (value >= 5) {
                wrapper.style.borderLeft = '4px solid #198754'; // Green
            } else if (value >= 4) {
                wrapper.style.borderLeft = '4px solid #0dcaf0'; // Blue
            } else if (value >= 3) {
                wrapper.style.borderLeft = '4px solid #ffc107'; // Yellow
            } else if (value >= 1) {
                wrapper.style.borderLeft = '4px solid #dc3545'; // Red
            } else {
                wrapper.style.borderLeft = '4px solid #20c997'; // Default
            }
        });
    });

    // Auto-save to localStorage
    const formElements = document.querySelectorAll('#judgingForm select, #judgingForm textarea');
    const teamId = {{ team.id }};
    
    formElements.forEach(element => {
        // Load saved values
        const savedValue = localStorage.getItem(`public_judge_${teamId}_${element.name}`);
        if (savedValue && !element.value) {
            element.value = savedValue;
            element.dispatchEvent(new Event('change'));
        }
        
        // Save on change
        element.addEventListener('input', function() {
            localStorage.setItem(`public_judge_${teamId}_${this.name}`, this.value);
        });
    });

    // Clear localStorage on form submit
    document.getElementById('judgingForm').addEventListener('submit', function() {
        formElements.forEach(element => {
            localStorage.removeItem(`public_judge_${teamId}_${element.name}`);
        });
    });
</script>
{% endblock %}