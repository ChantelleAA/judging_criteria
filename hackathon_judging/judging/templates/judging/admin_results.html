{% extends 'judging/base.html' %}
{% load custom_tags %}

{% block title %}Analytics Dashboard - Quantathon{% endblock %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/chartjs-chart-box-and-violin@4"></script>

<div class="row mb-4">
    <div class="col-lg-8">
        <h1 class="display-6 fw-bold mb-2">
            <i class="bi bi-bar-chart-fill me-3" style="color: var(--quantum-purple);"></i>
            Quantum Analytics Dashboard
        </h1>
        <p class="text-muted lead">Real-time competition insights and detailed scoring analysis</p>
    </div>
    <div class="col-lg-4 text-lg-end">
        <div class="btn-group mb-2" role="group">
            <button class="btn btn-outline-primary" onclick="refreshDashboard()">
                <i class="bi bi-arrow-clockwise me-2"></i>Refresh
            </button>
            <a href="{% url 'export_results' %}" class="btn btn-outline-success">
                <i class="bi bi-download me-2"></i>Export
            </a>
        </div>
        <div class="small text-muted">
            <i class="bi bi-clock me-1"></i>Last updated: {{ "now"|date:"g:i A" }}
        </div>
    </div>
</div>

<!-- Summary Statistics -->
<div class="row mb-4">
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="stat-card border-start  border-4">
            <div class="stat-number text-primary">{{ teams_with_scores.count }}</div>
            <div class="stat-label">Competing Teams</div>
            <div class="small text-muted mt-1">
                <i class="bi bi-people me-1"></i>Active participants
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="stat-card  border-4">
            <div class="stat-number text-success">{{ total_submissions }}</div>
            <div class="stat-label">Total Judgments</div>
            <div class="small text-muted mt-1">
                <i class="bi bi-check-circle me-1"></i>Submitted evaluations
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="stat-card border-start  border-4">
            <div class="stat-number text-info">{{ total_judges }}</div>
            <div class="stat-label">Expert Judges</div>
            <div class="small text-muted mt-1">
                <i class="bi bi-award me-1"></i>Industry professionals
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="stat-card border-start  border-4">
            <div class="stat-number text-warning">{% widthratio total_submissions total_judges 1 %}%</div>
            <div class="stat-label">Completion Rate</div>
            <div class="small text-muted mt-1">
                <i class="bi bi-graph-up me-1"></i>Overall progress
            </div>
        </div>
    </div>
</div>

<!-- Winners Podium -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h4 class="mb-0">
                    <i class="bi bi-trophy-fill me-2" style="color: gold;"></i>
                    Quantum Champions
                </h4>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    {% for team_score in teams_with_scores|slice:":3" %}
                        <div class="col-lg-4 mb-3">
                            <div class="position-relative">
                                <div class="card h-100 {% if team_score.rank == 1 %}border-warning bg-warning bg-opacity-10{% elif team_score.rank == 2 %}border-secondary bg-secondary bg-opacity-10{% elif team_score.rank == 3 %}border-warning bg-warning bg-opacity-5{% endif %}" 
                                     style="border-width: 3px !important;">
                                    <div class="card-body position-relative">
                                        {% if team_score.rank == 1 %}
                                            <div class="position-absolute top-0 start-50 translate-middle">
                                                <span class="badge bg-warning text-dark fs-4 rounded-circle p-2">
                                                    <i class="bi bi-crown-fill"></i>
                                                </span>
                                            </div>
                                        {% endif %}
                                        
                                        <div class="mt-3 mb-3">
                                           {% if team_score.rank == 1 %}
                                                <div class="medal-container mb-3">
                                                    {% load static %}
                                                    <img src="{% static 'images/medals/Medal 1.png' %}" 
                                                        alt="Gold Medal - 1st Place" 
                                                        class="medal-image gold-medal animate-medal"
                                                        style="width: 80px; height: 80px; object-fit: contain; filter: drop-shadow(0 4px 12px rgba(255, 215, 0, 0.4)); transition: all 0.3s ease;">
                                                </div>
                                            {% elif team_score.rank == 2 %}
                                                <div class="medal-container mb-3">
                                                    {% load static %}
                                                    <img src="{% static 'images/medals/Medal 2.png' %}" 
                                                        alt="Silver Medal - 2nd Place" 
                                                        class="medal-image silver-medal animate-medal"
                                                        style="width: 80px; height: 80px; object-fit: contain; filter: drop-shadow(0 4px 12px rgba(192, 192, 192, 0.4)); transition: all 0.3s ease;">
                                                </div>
                                            {% elif team_score.rank == 3 %}
                                                <div class="medal-container mb-3">
                                                    {% load static %}
                                                    <img src="{% static 'images/medals/Medal 3.png' %}" 
                                                        alt="Bronze Medal - 3rd Place" 
                                                        class="medal-image bronze-medal animate-medal"
                                                        style="width: 80px; height: 80px; object-fit: contain; filter: drop-shadow(0 4px 12px rgba(205, 127, 50, 0.4)); transition: all 0.3s ease;">
                                                </div>
                                            {% endif %}
                                        </div>
                                        
                                        <h5 class="fw-bold">{{ team_score.team.name }}</h5>
                                        <div class="display-6 fw-bold mb-2 bg-quantum-gradient" 
                                             style="-webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: white;">
                                            {{ team_score.final_weighted_score|floatformat:2 }}
                                        </div>
                                        <p class="text-muted mb-0">
                                            {% if team_score.rank == 1 %}Champion
                                            {% elif team_score.rank == 2 %}Runner-up  
                                            {% elif team_score.rank == 3 %}Third Place
                                            {% endif %}
                                        </p>
                                        
                                        <div class="mt-3">
                                            <canvas id="podiumChart{{ team_score.rank }}" width="200" height="100"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Data Visualization Section -->
<div class="row mb-4">
    <div class="col-12">
        <div class="viz-card">
            <!-- NEW VIZ TABS -->
            <div class="viz-tabs">
                <button class="viz-tab active" onclick="showChart('overview')" id="tab-overview">
                    <i class="bi bi-bar-chart me-1"></i>Final Scores
                </button>
                <button class="viz-tab" onclick="showChart('criterion')" id="tab-criterion">
                    <i class="bi bi-graph-up-arrow me-1"></i>Per&nbsp;Criterion
                </button>
                <button class="viz-tab" onclick="showChart('comparison')" id="tab-comparison">
                    <i class="bi bi-layers me-1"></i>Team Comparison
                </button>
                <button class="viz-tab" onclick="showChart('breakdown')" id="tab-breakdown">
                    <i class="bi bi-pie-chart me-1"></i>Team&nbsp;Breakdown
                </button>
                <button class="viz-tab" onclick="showChart('spread')" id="tab-spread">
                    <i class="bi bi-hdd-stack"></i> Spread
                </button>
            </div>

            <!-- chart containers -->
            <div id="chart-overview" class="chart-container">
                <canvas id="overviewChart" height="380"></canvas>
            </div>

            <div id="chart-criterion" class="chart-container" style="display:none;">
                <canvas id="criterionChart" height="380"></canvas>
            </div>

            <div id="chart-comparison" class="chart-container" style="display:none;">
                <canvas id="comparisonChart" height="380"></canvas>
            </div>

            <div id="chart-breakdown" class="chart-container" style="display:none;">
                <label for="teamSelect" class="form-label fw-bold">
                    Choose a team to see score breakdown
                </label>
                <select id="teamSelect" class="form-select mb-3"></select>
                <canvas id="teamBreakdownChart" height="380"></canvas>
            </div>

            <div id="chart-spread" class="chart-container" style="display:none;">
                <canvas id="spreadChart" height="380"></canvas>
            </div>
        </div>
    </div>
</div>


<!-- Detailed Rankings Table with Expandable Rows -->
<div class="r<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h4 class="mb-0">
                    <i class="bi bi-list-ol me-2"></i>
                    Complete Rankings
                </h4>
                <div class="d-flex gap-2">
                    <button class="btn btn-sm btn-outline-secondary text-white" onclick="toggleAllDetails()">
                        <i class="bi bi-arrows-expand me-1" id="toggleIcon"></i>
                        <span id="toggleText">Expand All</span>
                    </button>
                    <button class="btn btn-sm btn-outline-primary text-white" onclick="exportTableCSV()">
                        <i class="bi bi-filetype-csv me-1"></i>CSV
                    </button>
                    <button class="btn btn-sm btn-outline-success text-white" onclick="window.print()">
                        <i class="bi bi-printer me-1"></i>Print
                    </button>
                </div>
            </div>
            <div class="card-body p-0">
                {% if teams_with_scores %}
                    <div class="table-responsive">
                        <table class="table table-hover mb-1" id="rankingsTable">
                            <thead class="table-dark fw-normal">
                                <tr>
                                    <th class="text-center" width="30"></th>
                                    <th class="text-center" width="80">Rank</th>
                                    <th>Team</th>
                                    <th class="text-center fw-normal">Quantum Computing Relevance<br><small>(35%)</small></th>
                                    <th class="text-center fw-normal">Quantum Computing Quality<br><small>(25%)</small></th>
                                    <th class="text-center fw-normal">Social Impact Based on SDGs<br><small>(25%)</small></th>
                                    <th class="text-center fw-normal">Presentation and Originality<br><small>(15%)</small></th>
                                    <th class="text-center fw-normal" width="120">Final Score</th>
                                    <!-- <th class="text-center fw-normal" width="100">Actions</th> -->
                                </tr>
                            </thead>
                            <tbody>
                                {% for team_score in teams_with_scores %}
                                    <!-- Main Team Row -->
                                    <tr class="{% if team_score.rank <= 3 %}table-warning{% endif %} team-row" 
                                        onclick="toggleTeamDetails('team-{{ forloop.counter0 }}')"
                                        style="cursor: pointer;">
                                        
                                        <!-- Fixed expand icon cell -->
                                        <td class="text-center">
                                            <div class="expand-icon-container">
                                                <i class="bi bi-chevron-right expand-icon" id="icon-team-{{ forloop.counter0 }}"></i>
                                            </div>
                                        </td>
                                        
                                        <!-- Fixed rank badge cell -->
                                        <td class="text-center">
                                            {% if team_score.rank == 1 %}
                                                <span class="badge bg-warning text-dark rank-badge">🥇 {{ team_score.rank }}</span>
                                            {% elif team_score.rank == 2 %}
                                                <span class="badge bg-secondary rank-badge">🥈 {{ team_score.rank }}</span>
                                            {% elif team_score.rank == 3 %}
                                                <span class="badge bg-warning bg-opacity-40 text-dark rank-badge">🥉 {{ team_score.rank }}</span>
                                            {% else %}
                                                <span class="badge bg-light text-dark rank-badge">{{ team_score.rank }}</span>
                                            {% endif %}
                                        </td>
                                        
                                        <!-- Fixed team name cell -->
                                        <td class="team-name-cell">
                                            <div class="d-flex align-items-center">
                                                <div>
                                                    <h5 class="team-name">{{ team_score.team.name }}</h5>
                                                </div>
                                            </div>
                                        </td>
                                        
                                        <!-- Score cells with consistent alignment -->
                                        <td class="text-center">
                                            <div class="score-cell">
                                                <span class="text-dark fw-bold">
                                                    {{ team_score.quantum_tech_score|floatformat:1 }}
                                                </span>
                                                <div class="progress mt-1">
                                                    <div class="progress-bar bg-primary" style="width: {% widthratio team_score.quantum_tech_score 5 100 %}%"></div>
                                                </div>
                                            </div>
                                        </td>
                                        
                                        <td class="text-center">
                                            <div class="score-cell">
                                                <span class="text-dark fw-bold">
                                                    {{ team_score.social_impact_score|floatformat:1 }}
                                                </span>
                                                <div class="progress mt-1">
                                                    <div class="progress-bar bg-success" style="width: {% widthratio team_score.social_impact_score 5 100 %}%"></div>
                                                </div>
                                            </div>
                                        </td>
                                        
                                        <td class="text-center">
                                            <div class="score-cell">
                                                <span class="text-dark fw-bold">
                                                    {{ team_score.innovation_score|floatformat:1 }}
                                                </span>
                                                <div class="progress mt-1">
                                                    <div class="progress-bar bg-info" style="width: {% widthratio team_score.innovation_score 5 100 %}%"></div>
                                                </div>
                                            </div>
                                        </td>
                                        
                                        <td class="text-center">
                                            <div class="score-cell">
                                                <span class="text-dark fw-bold">
                                                    {{ team_score.presentation_score|floatformat:2 }}
                                                </span>
                                                <div class="progress mt-1">
                                                    <div class="progress-bar bg-warning" style="width: {% widthratio team_score.presentation_score 5 100 %}%"></div>
                                                </div>
                                            </div>
                                        </td>
                                        
                                        <!-- Fixed final score cell -->
                                        <td class="text-center">
                                            <div class="final-score">
                                                {{ team_score.final_weighted_score|floatformat:2 }}
                                            </div>
                                        </td>
                                        
                                    </tr>
                                    
                                    <!-- Expandable Details Row (unchanged) -->
                                    <tr class="team-details-row" id="details-team-{{ forloop.counter0 }}" style="display: none;">
                                        <td colspan="10" class="p-0">
                                            <!-- Your existing expandable content remains the same -->
                                            <div class="team-details-content" style="background: linear-gradient(135deg, rgba(107, 70, 193, 0.05) 0%, rgba(59, 130, 246, 0.05) 100%); border-left: 4px solid var(--quantum-purple);">
                                                
                                            </div>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="text-center py-5">
                        <div class="mb-4" style="font-size: 4rem; color: var(--quantum-purple); opacity: 0.5;">
                            <i class="bi bi-cpu"></i>
                        </div>
                        <h5 class="text-muted">No Results Available Yet</h5>
                        <p class="text-muted">Results will appear here as judges submit their evaluations.</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
// Expandable Rows JavaScript
function toggleTeamDetails(teamId) {
    const detailsRow = document.getElementById(`details-${teamId}`);
    const icon = document.getElementById(`icon-${teamId}`);
    
    if (detailsRow.style.display === 'none') {
        // Show details
        detailsRow.style.display = 'table-row';
        icon.classList.remove('bi-chevron-right');
        icon.classList.add('bi-chevron-down');
        
        // Create radar chart for this team
        setTimeout(() => createTeamRadarChart(teamId), 100);
        
        // Smooth scroll to the expanded content
        setTimeout(() => {
            detailsRow.scrollIntoView({ 
                behavior: 'smooth', 
                block: 'nearest' 
            });
        }, 200);
    } else {
        // Hide details
        detailsRow.style.display = 'none';
        icon.classList.remove('bi-chevron-down');
        icon.classList.add('bi-chevron-right');
    }
}

function toggleAllDetails() {
    const allDetailRows = document.querySelectorAll('.team-details-row');
    const allIcons = document.querySelectorAll('.expand-icon');
    const toggleBtn = document.getElementById('toggleText');
    const toggleIcon = document.getElementById('toggleIcon');
    
    const isAnyExpanded = Array.from(allDetailRows).some(row => row.style.display !== 'none');
    
    if (isAnyExpanded) {
        // Collapse all
        allDetailRows.forEach(row => row.style.display = 'none');
        allIcons.forEach(icon => {
            icon.classList.remove('bi-chevron-down');
            icon.classList.add('bi-chevron-right');
        });
        toggleBtn.textContent = 'Expand All';
        toggleIcon.classList.remove('bi-arrows-collapse');
        toggleIcon.classList.add('bi-arrows-expand');
    } else {
        // Expand all
        allDetailRows.forEach(row => row.style.display = 'table-row');
        allIcons.forEach(icon => {
            icon.classList.remove('bi-chevron-right');
            icon.classList.add('bi-chevron-down');
        });
        toggleBtn.textContent = 'Collapse All';
        toggleIcon.classList.remove('bi-arrows-expand');
        toggleIcon.classList.add('bi-arrows-collapse');
        
        // Create all radar charts
        setTimeout(() => {
            allDetailRows.forEach((row, index) => {
                createTeamRadarChart(`team-${index}`);
            });
        }, 100);
    }
}

function createTeamRadarChart(teamId) {
    const teamIndex = teamId.split('-')[1];
    const ctx = document.getElementById(`teamRadarChart-${teamIndex}`);
    
    if (!ctx || !teamsData || !teamsData[teamIndex]) {
        console.warn('Radar chart canvas or data not found for:', teamId);
        return;
    }
    
    const teamData = teamsData[teamIndex];
    
    // Destroy existing chart if it exists
    const existingChart = Chart.getChart(ctx);
    if (existingChart) {
        existingChart.destroy();
    }
    
    new Chart(ctx, {
        type: 'radar',
        data: {
            labels: criteriaLbl,
            datasets: [{
                label: teamData.team,
                data: criteriaLbl.map(crit => teamData.scores[crit] || 0),
                fill: true,
                backgroundColor: 'rgba(107, 70, 193, 0.2)',
                borderColor: 'rgba(107, 70, 193, 1)',
                pointBackgroundColor: 'rgba(107, 70, 193, 1)',
                pointBorderColor: '#fff',
                pointHoverBackgroundColor: '#fff',
                pointHoverBorderColor: 'rgba(107, 70, 193, 1)',
                pointRadius: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                r: {
                    beginAtZero: true,
                    max: 5,
                    ticks: {
                        stepSize: 1,
                        display: true
                    },
                    grid: {
                        color: 'rgba(0,0,0,0.1)'
                    },
                    angleLines: {
                        color: 'rgba(0,0,0,0.1)'
                    }
                }
            }
        }
    });
}

function exportTeamReport(teamName) {
    alert(`Exporting detailed report for ${teamName}...`);
    // Implement actual export functionality here
}

// Add hover effects for team rows
document.addEventListener('DOMContentLoaded', function() {
    const teamRows = document.querySelectorAll('.team-row');
    teamRows.forEach(row => {
        row.addEventListener('mouseenter', function() {
            this.style.backgroundColor = 'rgba(107, 70, 193, 0.1)';
        });
        row.addEventListener('mouseleave', function() {
            this.style.backgroundColor = '';
        });
    });
});
</script>

<style>
/* Medal Animation Styles */
.medal-container {
    display: flex;
    justify-content: center;
    align-items: center;
}

.medal-image {
    cursor: pointer;
    transform-origin: center;
}

.medal-image:hover {
    transform: scale(1.1) rotate(5deg);
    filter: brightness(1.1) drop-shadow(0 6px 16px rgba(0, 0, 0, 0.3)) !important;
}

.gold-medal:hover {
    filter: brightness(1.1) drop-shadow(0 6px 16px rgba(255, 215, 0, 0.6)) !important;
}

.silver-medal:hover {
    filter: brightness(1.1) drop-shadow(0 6px 16px rgba(192, 192, 192, 0.6)) !important;
}

.bronze-medal:hover {
    filter: brightness(1.1) drop-shadow(0 6px 16px rgba(205, 127, 50, 0.6)) !important;
}

/* Subtle floating animation */
.animate-medal {
    animation: float-medal 3s ease-in-out infinite;
}

@keyframes float-medal {
    0%, 100% { 
        transform: translateY(0px); 
    }
    50% { 
        transform: translateY(-5px); 
    }
}

/* Responsive medal sizes */
@media (max-width: 768px) {
    .medal-image {
        width: 60px !important;
        height: 60px !important;
    }
}

@media (max-width: 576px) {
    .medal-image {
        width: 50px !important;
        height: 50px !important;
    }
}

.team-row {
    transition: all 0.2s ease;
    cursor: pointer;
}

.team-row:hover {
    background-color: rgba(107, 70, 193, 0.1) !important;
}

.expand-icon {
    transition: transform 0.2s ease;
    color: var(--quantum-purple);
    font-weight: bold;
}

.team-details-row {
    border-top: none !important;
}

.team-details-content {
    animation: expandIn 0.3s ease-out;
}

@keyframes expandIn {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Enhanced progress bars for details */
.team-details-content .progress-bar {
    transition: width 0.6s ease;
}

/* Print styles */
@media print {
    .team-details-row {
        display: table-row !important;
    }
    .expand-icon {
        display: none !important;
    }
    .btn {
        display: none !important;
    }
}

/* Mobile responsiveness */
@media (max-width: 768px) {
    .team-details-content .container-fluid {
        padding: 1rem;
    }
    
    .team-details-content .card-body {
        padding: 1rem;
    }
    
    .team-details-content .row {
        margin-bottom: 1rem;
    }
}
.rank-badge {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 60px;
    height: 36px;
    font-size: 0.9rem;
    font-weight: 600;
}

/* Fix team name alignment */
.team-name-cell {
    vertical-align: middle;
}

.team-name {
    margin: 0;
    font-size: 1.1rem;
    font-weight: 600;
    line-height: 1.2;
}

/* Fix final score size */
.final-score {
    font-size: 1.5rem;
    font-weight: bold;
    color: var(--quantum-purple);
    line-height: 1;
}

/* Ensure all table cells are properly aligned */
.table td {
    vertical-align: middle;
}

/* Score cell improvements */
.score-cell {
    padding: 0.5rem;
}

.score-cell .fw-bold {
    font-size: 1rem;
}

/* Progress bar consistency */
.progress {
    height: 4px;
}

/* Button group alignment */
.action-buttons {
    white-space: nowrap;
}

/* Fix expand icon alignment */
.expand-icon-container {
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100%;
    min-height: 40px;
}

</style>

{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-chart-box-and-violin@3/dist/chartjs-chart-box-and-violin.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-chart-matrix@1/dist/chartjs-chart-matrix.min.js"></script>

<script>
/* ------------- 0. Raw data from Django -------------- */
const teamsData = {{ teams_json|safe }};
const criteriaLbl = {{ criteria_labels|safe }};
const rawScores = {{ all_scores_json|safe }};

/* ------------- 1. Helper palette and constants -------------------- */
const palette = ['#2B29F0','#06B6D4','#3B82F6','#8B5CF6','#EC4899'];

// FIXED: Criteria weights with CORRECT names
const criteriaWeights = {
    "Quantum Computing Relevance": 35, 
    "Quantum Computing Quality": 25,  
    "Social Impact Based on SDGs": 25,          
    "Presentation and Originality": 15,          
};

/* ------------- 2. Final Scores (bar) ---------------- */
new Chart(document.getElementById('overviewChart'), {
    type: 'bar',
    data: {
        labels: teamsData.map(t => t.team),
        datasets: [{
            label: 'Final Score',
            data: teamsData.map(t => t.final_weighted_score),
            backgroundColor: palette[0],
            hoverBackgroundColor: '#2C0083'
        }]
    },
    options: {
        responsive: true,
        plugins: {
            legend: { display: false }
        },
        scales: {
            y: { beginAtZero: true, max: 5 }
        }
    }
});

console.log('=== CHART DEBUG ===');
console.log('Criteria Labels:', criteriaLbl);
console.log('Teams Data:', teamsData);

if (teamsData.length > 0) {
    console.log('First team scores object:', teamsData[0].scores);
    console.log('Score keys:', Object.keys(teamsData[0].scores));
    
    // Test mapping
    criteriaLbl.forEach(c => {
        console.log(`Looking for "${c}":`, teamsData[0].scores[c]);
    });
}

new Chart(document.getElementById('criterionChart'), {
    type: 'bar',
    data: {
        labels: criteriaLbl,
        datasets: teamsData.map((t, i) => ({
            label: t.team,
            data: criteriaLbl.map(c => t.scores[c] || 0),
            backgroundColor: palette[i % palette.length]
        }))
    },
    options: {
        responsive: true,
        plugins: {
            title: { display: true, text: 'Per-Criterion Scores' }
        },
        scales: {
            y: { beginAtZero: true, max: 5 } 
        }
    }
});

const top3 = teamsData.slice(0, 3);
new Chart(document.getElementById('comparisonChart'), {
    type: 'radar',
    data: {
        labels: criteriaLbl,
        datasets: top3.map((t, i) => ({
            label: t.team,
            data: criteriaLbl.map(c => t.scores[c] || 0),
            fill: true,
            backgroundColor: palette[i] + '55',
            borderColor: palette[i]
        }))
    },
    options: {
        responsive: true,
        plugins: {
            title: { display: true, text: 'Top 3 Comparison' }
        },
        scales: {
            r: { beginAtZero: true, max: 5 }  // Fixed to 5-point scale
        }
    }
});

/* ------------- 5. Team breakdown (doughnut) --------- */
const sel = document.getElementById('teamSelect');
teamsData.forEach(t => {
    const o = document.createElement('option');
    o.value = t.team;
    o.text = t.team;
    sel.appendChild(o);
});

let breakdownChart;
function drawBreak(teamName) {
    const t = teamsData.find(x => x.team === teamName);
    if (!t) return;
    if (breakdownChart) breakdownChart.destroy();
    breakdownChart = new Chart(document.getElementById('teamBreakdownChart'), {
        type: 'doughnut',
        data: {
            labels: criteriaLbl,
            datasets: [{
                data: criteriaLbl.map(c => t.scores[c] || 0),
                backgroundColor: palette
            }]
        },
        options: {
            plugins: {
                title: { display: true, text: `${teamName} Breakdown` }
            }
        }
    });
}

sel.addEventListener('change', e => drawBreak(e.target.value));
if (sel.options.length > 0) drawBreak(sel.options[0].value);

/* ------------- 6. Score Spread Histogram ----- */
try {
    const spreadCtx = document.getElementById('spreadChart');
    
    if (rawScores && rawScores.length > 0) {
        const histogramBuckets = [1, 2, 3, 4, 5];  // Fixed to 5-point scale
        const histDS = criteriaLbl.map((crit, i) => {
            const arr = histogramBuckets.map(b =>
                rawScores.filter(r => r.criteria__name === crit && Math.floor(r.score) === b).length
            );
            return {
                label: crit,
                data: arr,
                backgroundColor: palette[i % palette.length]
            };
        });

        new Chart(spreadCtx, {
            type: 'bar',
            data: { labels: histogramBuckets.map(b => b.toString()), datasets: histDS },
            options: {
                responsive: true,
                plugins: { title: { display: true, text: 'Score Distribution by Criteria' } },
                scales: { y: { beginAtZero: true } }
            }
        });
    } else {
        new Chart(spreadCtx, {
            type: 'bar',
            data: {
                labels: criteriaLbl,
                datasets: [{
                    label: 'Average Score',
                    data: criteriaLbl.map(crit => {
                        const scores = teamsData.map(t => t.scores[crit] || 0);
                        return scores.reduce((a, b) => a + b, 0) / scores.length;
                    }),
                    backgroundColor: palette[0]
                }]
            },
            options: {
                responsive: true,
                plugins: { title: { display: true, text: 'Average Scores by Criteria' } },
                scales: { y: { beginAtZero: true, max: 5 } }  // Fixed to 5-point scale
            }
        });
    }
} catch (error) {
    console.error('Spread chart error:', error);
}

/* ------------- 7. Tab switch logic ------------------ */
function showChart(kind) {
    document.querySelectorAll('.chart-container').forEach(c => c.style.display = 'none');
    const shown = document.getElementById('chart-' + kind);
    if (shown) {
        shown.style.display = 'block';
        document.querySelectorAll('.viz-tab').forEach(b => b.classList.remove('active'));
        const activeTab = document.getElementById('tab-' + kind);
        if (activeTab) activeTab.classList.add('active');
        shown.querySelectorAll('canvas').forEach(cv => {
            const chart = Chart.getChart(cv);
            if (chart) chart.resize();
        });
    }
}

/* ------------- 8. Utility functions ----- */
function refreshDashboard() {
    location.reload();
}

function exportTableCSV() {
    const table = document.getElementById('rankingsTable');
    if (!table) return;
    
    let csv = [];
    const rows = table.querySelectorAll('tr');
    
    for (let i = 0; i < rows.length; i++) {
        const row = [];
        const cols = rows[i].querySelectorAll('td, th');
        
        for (let j = 0; j < cols.length; j++) {
            let cellText = cols[j].textContent.trim().replace(/\s+/g, ' ');
            row.push('"' + cellText + '"');
        }
        csv.push(row.join(','));
    }
    
    const csvContent = csv.join('\n');
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.setAttribute('hidden', '');
    a.setAttribute('href', url);
    a.setAttribute('download', 'rankings.csv');
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
}

/* ------------- 9. FIXED MODAL FUNCTIONS ------------- */

function showTeamDetails(teamId, teamName) {
    console.log('Opening modal for:', teamName); // Debug log
    
    // Set modal title
    const modalTitle = document.getElementById('modalTeamName');
    if (modalTitle) {
        modalTitle.textContent = teamName;
    }
    
    // Find team data immediately
    const teamData = teamsData.find(t => t.team === teamName);
    console.log('Found team data:', teamData); // Debug log
    
    const detailsDiv = document.getElementById('teamDetails');
    
    if (teamData && detailsDiv) {
        generateTeamDetails(teamData, detailsDiv);
    } else {
        detailsDiv.innerHTML = `
            <div class="text-center py-4">
                <div class="text-danger mb-3" style="font-size: 3rem;">
                    <i class="bi bi-exclamation-triangle"></i>
                </div>
                <h5>Team data not found</h5>
                <p class="text-muted">Unable to load details for ${teamName}</p>
            </div>
        `;
    }
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('teamModal'));
    modal.show();
}

function generateTeamDetails(teamData, container) {
    console.log('Generating details for:', teamData.team); // Debug log
    
    const content = `
        <div class="row mb-4">
            <div class="col-md-8">
                <div class="card score-breakdown-card h-100">
                    <div class="card-header bg-light">
                        <h6 class="mb-0">
                            <i class="bi bi-graph-up me-2"></i>Score Breakdown
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            ${criteriaLbl.map(crit => {
                                const score = teamData.scores[crit] || 0;
                                const weight = criteriaWeights[crit] || 0;
                                const percentage = Math.min((score / 5) * 100, 100);  // Fixed to 5-point scale
                                
                                // Color coding based on score
                                let colorClass = 'bg-danger';
                                if (score >= 4) colorClass = 'bg-success';
                                else if (score >= 3) colorClass = 'bg-warning';
                                else if (score >= 2) colorClass = 'bg-info';
                                
                                return `
                                    <div class="col-md-6 mb-3">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <span class="fw-medium">${crit}</span>
                                            <div class="text-end">
                                                <span class="fw-bold" style="font-size: 1.2rem;">${score.toFixed(1)}</span>
                                                <span class="text-muted small">(${weight}%)</span>
                                            </div>
                                        </div>
                                        <div class="progress" style="height: 8px;">
                                            <div class="progress-bar ${colorClass}" 
                                                 style="width: ${percentage}%" 
                                                 role="progressbar" 
                                                 aria-valuenow="${score}" 
                                                 aria-valuemin="0" 
                                                 aria-valuemax="5">
                                            </div>
                                        </div>
                                        <div class="small text-muted mt-1">${score.toFixed(1)}/5.0</div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        
                        <hr class="my-4">
                        
                        <div class="text-center">
                            <h6 class="text-muted mb-2">Weighted Final Score</h6>
                            <div class="final-score-display">
                                ${teamData.final_weighted_score.toFixed(2)}
                            </div>
                            <div class="text-muted">
                                <i class="bi bi-trophy-fill me-1" style="color: gold;"></i>
                                Rank #${teamData.rank || 'N/A'}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-4">
                <div class="card score-breakdown-card h-100">
                    <div class="card-header bg-light">
                        <h6 class="mb-0">
                            <i class="bi bi-people me-2"></i>Team Information
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <strong>Team Members:</strong>
                            <p class="mb-2 small">${teamData.members || 'Not specified'}</p>
                        </div>
                        
                        <div class="mb-3">
                            <strong>Project Description:</strong>
                            <p class="mb-2 small">${teamData.description || 'No description available'}</p>
                        </div>
                        
                        ${teamData.presentation_link ? `
                            <div class="mb-3">
                                <a href="${teamData.presentation_link}" target="_blank" class="btn btn-outline-primary w-100">
                                    <i class="bi bi-play-circle me-2"></i>View Presentation
                                </a>
                            </div>
                        ` : ''}
                        
                        <div class="mb-3">
                            <strong>Performance Summary:</strong>
                            <div class="row text-center mt-2">
                                <div class="col-6">
                                    <div class="border rounded p-2">
                                        <div class="fw-bold text-primary">${Math.max(...criteriaLbl.map(c => teamData.scores[c] || 0)).toFixed(1)}</div>
                                        <small class="text-muted">Highest</small>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="border rounded p-2">
                                        <div class="fw-bold text-secondary">${Math.min(...criteriaLbl.map(c => teamData.scores[c] || 0)).toFixed(1)}</div>
                                        <small class="text-muted">Lowest</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="text-center">
                            <canvas id="teamRadarChart" style="max-height: 200px;"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row">
            <div class="col-12">
                <div class="card score-breakdown-card">
                    <div class="card-header bg-light">
                        <h6 class="mb-0">
                            <i class="bi bi-bar-chart me-2"></i>Detailed Analysis
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6>Strengths (≥ 4.0)</h6>
                                <ul class="list-unstyled">
                                    ${criteriaLbl
                                        .filter(crit => (teamData.scores[crit] || 0) >= 4)
                                        .map(crit => `
                                            <li class="mb-1">
                                                <i class="bi bi-check-circle-fill text-success me-2"></i>
                                                <strong>${crit}:</strong> ${(teamData.scores[crit] || 0).toFixed(1)}/5
                                            </li>
                                        `).join('')}
                                </ul>
                                ${criteriaLbl.filter(crit => (teamData.scores[crit] || 0) >= 4).length === 0 ? 
                                    '<p class="text-muted small">No scores above 4.0</p>' : ''}
                            </div>
                            <div class="col-md-6">
                                <h6>Areas for Improvement (< 4.0)</h6>
                                <ul class="list-unstyled">
                                    ${criteriaLbl
                                        .filter(crit => (teamData.scores[crit] || 0) < 4)
                                        .map(crit => `
                                            <li class="mb-1">
                                                <i class="bi bi-exclamation-circle-fill text-warning me-2"></i>
                                                <strong>${crit}:</strong> ${(teamData.scores[crit] || 0).toFixed(1)}/5
                                            </li>
                                        `).join('')}
                                </ul>
                                ${criteriaLbl.filter(crit => (teamData.scores[crit] || 0) < 4).length === 0 ? 
                                    '<p class="text-muted small">All scores above 4.0!</p>' : ''}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    container.innerHTML = content;
    
    // Create radar chart immediately
    createTeamRadarChart(teamData);
}

// FIXED: Single radar chart function
function createTeamRadarChart(teamData) {
    const ctx = document.getElementById('teamRadarChart');
    if (!ctx) {
        console.error('Radar chart canvas not found');
        return;
    }
    
    // Destroy existing chart if it exists
    const existingChart = Chart.getChart(ctx);
    if (existingChart) {
        existingChart.destroy();
    }
    
    console.log('Creating radar chart for:', teamData.team); // Debug log
    
    new Chart(ctx, {
        type: 'radar',
        data: {
            labels: criteriaLbl,
            datasets: [{
                label: teamData.team,
                data: criteriaLbl.map(crit => teamData.scores[crit] || 0),
                fill: true,
                backgroundColor: 'rgba(107, 70, 193, 0.2)',
                borderColor: 'rgba(107, 70, 193, 1)',
                pointBackgroundColor: 'rgba(107, 70, 193, 1)',
                pointBorderColor: '#fff',
                pointHoverBackgroundColor: '#fff',
                pointHoverBorderColor: 'rgba(107, 70, 193, 1)',
                pointRadius: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                r: {
                    beginAtZero: true,
                    max: 5,  // Fixed to 5-point scale
                    ticks: {
                        stepSize: 1,
                        display: false
                    },
                    grid: {
                        color: 'rgba(0,0,0,0.1)'
                    },
                    angleLines: {
                        color: 'rgba(0,0,0,0.1)'
                    }
                }
            }
        }
    });
}

function exportTeamReport() {
    const teamName = document.getElementById('modalTeamName').textContent;
    alert(`Export functionality for ${teamName} - implement as needed`);
}

function updateComparisonChart() {
    console.log('Comparison chart update requested');
}

// Debug: Test if modal works
console.log('Modal functions loaded. Available teams:', teamsData.map(t => t.team));

// TEST FUNCTIONS - Add at the very end of your script section
function testModal() {
    console.log('Test modal function called');
    
    // Test 1: Check if modal element exists
    const modalElement = document.getElementById('teamModal');
    console.log('Modal element found:', modalElement ? 'YES' : 'NO');
    
    // Test 2: Check if Bootstrap is loaded
    console.log('Bootstrap loaded:', typeof bootstrap !== 'undefined' ? 'YES' : 'NO');
    
    if (modalElement && typeof bootstrap !== 'undefined') {
        try {
            const modal = new bootstrap.Modal(modalElement);
            console.log('Modal object created successfully');
            modal.show();
            console.log('Modal show() called');
        } catch (error) {
            console.error('Error creating/showing modal:', error);
        }
    } else {
        console.error('Missing modal element or Bootstrap');
    }
}

function testTeamFunction() {
    console.log('Testing team function...');
    if (typeof teamsData !== 'undefined' && teamsData.length > 0) {
        const firstTeam = teamsData[0];
        console.log('First team:', firstTeam);
        alert(`Found team: ${firstTeam.team}`);
        showTeamDetails(1, firstTeam.team);
    } else {
        alert('No teams data found!');
    }
}
</script>

<style>
    .chart-container canvas {
        min-height: 380px !important;
    }

    .score-cell {
        min-width: 80px;
    }
    
    .final-score {
        min-width: 100px;
    }
    
    .team-row {
        transition: all 0.2s ease;
        cursor: pointer;
    }
    
    .team-row:hover {
        background-color: rgba(107, 70, 193, 0.1) !important;
    }
    
    .chart-container canvas {
        max-height: 400px;
    }

    /* Enhanced Modal Styles */
    .score-breakdown-card {
        border: none;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        transition: transform 0.2s ease;
    }

    .score-breakdown-card:hover {
        transform: translateY(-2px);
    }

    .criteria-score {
        font-size: 1.5rem;
        font-weight: bold;
    }

    .criteria-weight {
        font-size: 0.9rem;
        opacity: 0.7;
    }

/* Ensure modal appears above everything */
.modal {
    z-index: 1055 !important;
}

.modal-backdrop {
    z-index: 1050 !important;
    opacity: 0.5 !important;
}

/* Ensure modal content is fully visible */
.modal-dialog {
    z-index: 1056 !important;
}

/* Remove any conflicting styles that might fade the modal */
.modal.show .modal-dialog {
    opacity: 1 !important;
    transform: none !important;
}

/* Ensure modal content loads without fade delays */
.modal-content {
    opacity: 1 !important;
    transition: none !important;
}

    .final-score-display {
        font-size: 3rem;
        font-weight: bold;
        background: linear-gradient(135deg, var(--quantum-purple) 0%, var(--quantum-blue) 100%);
        -webkit-background-clip: text;
        background-clip: text;
        -webkit-text-fill-color: transparent;
    }

    .judge-feedback {
        background: #f8f9fa;
        border-left: 4px solid var(--quantum-purple);
        padding: 1rem;
        margin: 0.5rem 0;
    }

    .performance-indicator {
        height: 8px;
        border-radius: 4px;
        overflow: hidden;
        background: #e9ecef;
    }

    .performance-bar {
        height: 100%;
        transition: width 0.3s ease;
    }
    
    @media print {
        .btn, .viz-tabs, .modal { 
            display: none !important; 
        }
        .card { 
            border: 1px solid #000 !important; 
        }
    }
</style>
{% endblock %}